-- ====================================================================
-- 数据库初始化脚本
-- ====================================================================
-- 脚本名称：setup_database.sql
-- 用途：创建数据库和用户，准备Flyway迁移环境
-- 作者：数据库团队
-- 日期：2025-10-30
-- ====================================================================

-- 设置SQL模式
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ====================================================================
-- 1. 创建数据库（如果不存在）
-- ====================================================================
CREATE DATABASE IF NOT EXISTS knene_movie
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci
COMMENT '影视资源下载网站数据库';

-- ====================================================================
-- 2. 创建数据库用户（如果不存在）
-- ====================================================================

-- 创建应用用户（如果不存在）
CREATE USER IF NOT EXISTS 'knene_app'@'localhost'
IDENTIFIED BY 'knene_app_2025'
DEFAULT CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

-- 为应用用户授权
GRANT ALL PRIVILEGES ON knene_movie.* TO 'knene_app'@'localhost'
WITH GRANT OPTION;

-- 刷新权限
FLUSH PRIVILEGES;

-- ====================================================================
-- 3. 验证数据库创建
-- ====================================================================

-- 显示数据库信息
SELECT
    SCHEMA_NAME as '数据库名称',
    DEFAULT_CHARACTER_SET_NAME as '字符集',
    DEFAULT_COLLATION_NAME as '排序规则'
FROM information_schema.SCHEMATA
WHERE SCHEMA_NAME = 'knene_movie';

-- 显示用户权限
SHOW GRANTS FOR 'knene_app'@'localhost';

-- ====================================================================
-- 4. 数据库配置信息
-- ====================================================================

-- 显示数据库配置
SELECT
    @@character_set_database as '数据库字符集',
    @@collation_database as '数据库排序规则',
    @@time_zone as '时区',
    @@version as 'MySQL版本';

-- ====================================================================
-- 使用数据库
-- ====================================================================
USE knene_movie;

-- ====================================================================
-- 准备完成提示
-- ====================================================================
SELECT '数据库初始化完成！' as '状态',
       'knene_movie' as '数据库名称',
       'knene_app' as '应用用户',
       NOW() as '初始化时间';

-- ====================================================================
-- 使用说明
-- ====================================================================
/*
1. 执行此脚本创建数据库和用户
2. 修改application-database.yml中的连接配置：
   - username: knene_app
   - password: knene_app_2025
3. 启动Spring Boot应用，指定profile: database
4. Flyway将自动执行迁移脚本

注意事项：
- 确保MySQL服务已启动
- 确保有创建数据库和用户的权限
- 生产环境请修改默认密码
- 如需其他数据库配置，请修改相应参数
*/