# 影视资源平台开发需求与进度文档

> **项目名称**: 影视资源下载平台  
> **文档版本**: v1.0.0  
> **创建日期**: 2025-10-26  
> **最后更新**: 2025-10-26  
> **文档作者**: mosctz

---

## 📋 目录

1. [项目概述](#1-项目概述)
2. [技术架构](#2-技术架构)
3. [已完成工作清单](#3-已完成工作清单)
4. [待完成工作清单](#4-待完成工作清单)
5. [详细开发任务](#5-详细开发任务)
6. [API接口文档](#6-api接口文档)
7. [爬虫系统设计](#7-爬虫系统设计)
8. [开发周期估算](#8-开发周期估算)
9. [部署与运维](#9-部署与运维)

---

## 1. 项目概述

### 1.1 项目简介

这是一个全栈影视资源下载平台,支持影片、电视剧、写真图片集等多种资源类型的浏览、搜索和下载。平台采用前后端分离架构,前端使用React + TypeScript + DDD架构,后端使用Java + Spring Boot + Redis等技术栈。

### 1.2 核心功能

- **资源浏览**: 影片、电视剧、写真图片集的分类浏览
- **搜索功能**: 全文搜索、高级筛选、智能推荐
- **用户系统**: 注册登录、个人中心、VIP会员
- **下载管理**: 下载队列、进度跟踪、断点续传
- **内容管理**: 管理员后台、内容审核、批量上传
- **爬虫系统**: 自动爬取免费资源(如YTS)和VIP资源
- **评论互动**: 评分、评论、收藏、点赞

### 1.3 用户角色

- **游客**: 浏览免费内容
- **注册用户**: 下载免费资源、评论互动
- **VIP用户**: 访问VIP专享资源、无限下载
- **管理员**: 内容管理、用户管理、系统配置
- **超级管理员**: 完整系统权限

---

## 2. 技术架构

### 2.1 前端技术栈

#### 核心框架
- **React 18.2.0**: UI框架
- **TypeScript 5.2.2**: 类型安全
- **Vite 5.0.0**: 构建工具
- **pnpm 8.10.0**: 包管理器

#### 状态管理
- **Zustand 4.5.7**: 轻量级状态管理
- **TanStack Query 5.90.2**: 服务端状态管理
- **Immer 10.0.3**: 不可变数据

#### 路由与导航
- **React Router 6.30.1**: 客户端路由

#### UI组件库
- **Radix UI**: 无障碍组件基础
  - @radix-ui/react-dialog
  - @radix-ui/react-dropdown-menu
  - @radix-ui/react-select
  - @radix-ui/react-toast
  - @radix-ui/react-tooltip
  - @radix-ui/react-progress
- **Headless UI 1.7.17**: 无样式组件
- **Lucide React 0.548.0**: 图标库

#### 样式方案
- **Tailwind CSS 3.3.6**: 原子化CSS
- **PostCSS 8.4.32**: CSS处理
- **Tailwind Merge 2.0.0**: 类名合并
- **clsx 2.0.0**: 条件类名
- **next-themes 0.4.6**: 主题切换

#### 表单处理
- **React Hook Form 7.48.2**: 表单管理
- **Zod 3.22.4**: 数据验证
- **@hookform/resolvers 3.3.2**: 表单验证集成

#### 工具库
- **date-fns 2.30.0**: 日期处理

#### 开发工具
- **ESLint 8.57.1**: 代码检查
- **Prettier 3.6.2**: 代码格式化
- **Husky 8.0.3**: Git钩子
- **lint-staged 15.1.0**: 暂存文件检查

#### 测试框架
- **Vitest 1.0.0**: 单元测试
- **@testing-library/react 14.1.2**: 组件测试
- **Playwright 1.40.0**: E2E测试
- **@vitest/coverage-v8**: 测试覆盖率

#### 文档工具
- **Storybook 7.5.3**: 组件文档

### 2.2 后端技术栈

#### 核心框架
- **Java 17+**: 编程语言
- **Spring Boot 3.x**: 应用框架
- **Spring Security**: 安全框架
- **Spring Data JPA**: 数据访问
- **Spring Cache**: 缓存抽象

#### 数据库
- **MySQL 8.0+**: 主数据库
- **Redis 7.0+**: 缓存和会话存储
- **Elasticsearch 8.x**: 全文搜索引擎

#### 消息队列
- **RabbitMQ** 或 **Kafka**: 异步任务处理

#### 文件存储
- **MinIO** 或 **阿里云OSS**: 对象存储
- **本地文件系统**: 开发环境

#### 爬虫技术
- **Selenium 4.x**: 浏览器自动化
- **Jsoup**: HTML解析
- **OkHttp**: HTTP客户端
- **大模型集成**: 
  - OpenAI GPT-4
  - Claude 3
  - 本地部署的开源模型(如Llama 3)

#### 监控与日志
- **Spring Boot Actuator**: 应用监控
- **Logback**: 日志框架
- **ELK Stack**: 日志分析
- **Prometheus + Grafana**: 指标监控

#### 开发工具
- **Maven** 或 **Gradle**: 构建工具
- **Swagger/OpenAPI**: API文档
- **JUnit 5**: 单元测试
- **Mockito**: Mock框架

### 2.3 架构设计

#### 前端架构 - DDD分层

```
src/
├── presentation/          # 表现层
│   ├── components/       # UI组件
│   │   ├── atoms/       # 原子组件
│   │   ├── molecules/   # 分子组件
│   │   ├── organisms/   # 有机体组件
│   │   ├── templates/   # 模板组件
│   │   ├── guards/      # 路由守卫
│   │   ├── layers/      # 图层组件
│   │   └── domains/     # 业务领域组件
│   ├── pages/           # 页面组件
│   ├── hooks/           # 表现层Hooks
│   └── router/          # 路由配置
├── application/          # 应用层
│   ├── services/        # 应用服务
│   ├── stores/          # 状态管理
│   ├── hooks/           # 应用层Hooks
│   └── providers/       # 上下文提供者
├── domain/              # 领域层
│   ├── entities/        # 实体
│   ├── value-objects/   # 值对象
│   ├── services/        # 领域服务
│   └── events/          # 领域事件
├── infrastructure/      # 基础设施层
│   ├── api/            # API调用
│   ├── repositories/   # 仓储实现
│   ├── storage/        # 存储服务
│   ├── cache/          # 缓存管理
│   └── services/       # 外部服务
├── tokens/             # 设计令牌
├── types/              # 类型定义
└── utils/              # 工具函数
```

#### 后端架构 - 分层架构

```
src/main/java/com/movie/
├── controller/          # 控制器层
│   ├── api/            # REST API
│   └── admin/          # 管理后台API
├── service/            # 服务层
│   ├── impl/           # 服务实现
│   └── crawler/        # 爬虫服务
├── repository/         # 数据访问层
├── entity/             # 实体类
├── dto/                # 数据传输对象
├── vo/                 # 视图对象
├── config/             # 配置类
├── security/           # 安全配置
├── exception/          # 异常处理
├── util/               # 工具类
└── aspect/             # 切面
```

---

## 3. 已完成工作清单

### 3.1 前端已完成 ✅

#### 基础架构 (100%)
- [x] 项目初始化和配置
- [x] Vite构建配置
- [x] TypeScript配置
- [x] ESLint + Prettier配置
- [x] Husky + lint-staged配置
- [x] 路径别名配置(@别名系统)
- [x] 环境变量配置

#### DDD架构实现 (100%)
- [x] 四层架构目录结构
- [x] 领域实体定义(Movie, Photo, User, Download等)
- [x] 值对象定义(Rating, Duration, Genre等)
- [x] 领域服务实现
- [x] 应用服务实现
- [x] 仓储模式实现

#### UI组件系统 (90%)
- [x] 原子组件(Button, Input, Badge, Icon等)
- [x] 分子组件(SearchBox, NavigationMenu等)
- [x] 有机体组件(Header, HeroSection等)
- [x] 图层组件系统(MovieLayer, ImageLayer等)
- [x] 领域组件(最新更新、热门、合集等)
- [x] 路由守卫组件(ProtectedRoute, AdminRoute等)
- [x] 模板组件(AuthTemplate, UserTemplate, AdminTemplate)

#### 样式系统 (100%)
- [x] Tailwind CSS配置
- [x] 设计令牌系统(colors, spacing, typography等)
- [x] 组件变体系统
- [x] 响应式配置
- [x] 主题切换(亮色/暗色)

#### 状态管理 (90%)
- [x] Zustand stores(user, movie, download, ui)
- [x] TanStack Query配置
- [x] 自定义Hooks(useAuth, useMovies, useDownloads等)

#### 路由系统 (100%)
- [x] React Router配置
- [x] 路由模块化(auth, user, movie, photo, collection, admin)
- [x] 路由守卫实现
- [x] 路由常量定义

#### 页面实现 (70%)
- [x] 首页(HomePage)
- [x] 影片详情页(MovieDetailPage)
- [x] 写真详情页(PhotoDetailPage)
- [x] 合集列表页(CollectionsListPage)
- [x] 合集详情页(CollectionDetailPage)
- [x] 最新更新页(LatestUpdateListPage)
- [x] 热门页面(HotListPage)
- [x] 用户中心页面(Dashboard, Profile, Downloads, Favorites, Messages, Settings)
- [x] 认证页面(Login, Register, ForgotPassword, ResetPassword)
- [x] 管理后台页面(Dashboard, Users, Movies, System)
- [x] 错误页面(404, Unauthorized, Error)
- [ ] 搜索页面(MovieSearchPage) - 待完善
- [ ] 分类页面(MovieCategoryPage) - 待完善

#### API集成 (60%)
- [x] API客户端封装(ApiClient)
- [x] API端点配置(endpoints.ts)
- [x] Mock数据服务
- [x] 认证API(authApi)
- [x] 用户API(userApi)
- [x] 影片API(movieApi)
- [x] 下载API(downloadApi)
- [ ] 实际后端API集成 - 待完成

#### 测试 (30%)
- [x] 测试环境配置
- [x] 部分组件单元测试
- [x] 数据流集成测试
- [ ] 完整测试覆盖 - 待完成
- [ ] E2E测试 - 待完成

### 3.2 后端已完成 ✅

#### 基础架构 (0%)
- [ ] 项目初始化 - 未开始
- [ ] Spring Boot配置 - 未开始
- [ ] 数据库设计 - 未开始
- [ ] Redis配置 - 未开始

**注意**: 后端目录(KneneBackend)当前为空,所有后端工作尚未开始。

---

## 4. 待完成工作清单

### 4.1 前端待完成 🚧

#### 页面完善 (30%)
- [ ] 搜索页面功能完善
  - [ ] 高级搜索筛选
  - [ ] 搜索结果排序
  - [ ] 搜索历史
  - [ ] 热门搜索推荐
- [ ] 分类页面功能完善
  - [ ] 分类筛选器
  - [ ] 分页加载
  - [ ] 排序选项
- [ ] 写真列表页(PhotoListPage)功能完善
- [ ] 专题合集页(SpecialCollectionsPage)功能完善

#### 功能增强 (0%)
- [ ] 下载管理器
  - [ ] 下载队列管理
  - [ ] 下载进度实时更新
  - [ ] 断点续传
  - [ ] 下载速度限制
- [ ] 播放器集成
  - [ ] 在线预览
  - [ ] 字幕支持
  - [ ] 播放历史记录
- [ ] 社交功能
  - [ ] 评论系统完善
  - [ ] 点赞/收藏
  - [ ] 用户关注
  - [ ] 消息通知
- [ ] 支付系统
  - [ ] VIP会员购买
  - [ ] 支付宝/微信支付集成
  - [ ] 订单管理

#### 性能优化 (0%)
- [ ] 代码分割优化
- [ ] 图片懒加载
- [ ] 虚拟滚动
- [ ] Service Worker缓存
- [ ] CDN集成

#### 测试完善 (70%)
- [ ] 组件单元测试覆盖率达到80%
- [ ] 集成测试
- [ ] E2E测试场景
- [ ] 性能测试

#### 文档完善 (50%)
- [ ] Storybook组件文档
- [ ] API使用文档
- [ ] 部署文档
- [ ] 开发规范文档

### 4.2 后端待完成 🚧

#### 基础架构 (0%)
- [ ] Spring Boot项目初始化
- [ ] 多环境配置(dev, test, prod)
- [ ] 日志配置
- [ ] 异常处理框架
- [ ] 统一响应格式

#### 数据库设计 (0%)
- [ ] 用户表设计
- [ ] 影片表设计
- [ ] 写真表设计
- [ ] 合集表设计
- [ ] 下载记录表设计
- [ ] 评论表设计
- [ ] 订单表设计
- [ ] 数据库索引优化
- [ ] 数据库迁移脚本

#### 核心功能 (0%)
- [ ] 用户认证与授权
  - [ ] JWT Token生成与验证
  - [ ] 刷新Token机制
  - [ ] 权限控制(RBAC)
  - [ ] 社交登录集成
- [ ] 用户管理
  - [ ] 用户注册
  - [ ] 用户登录
  - [ ] 密码找回
  - [ ] 个人信息管理
  - [ ] VIP会员管理
- [ ] 影片管理
  - [ ] 影片CRUD
  - [ ] 影片搜索
  - [ ] 影片分类
  - [ ] 影片推荐算法
  - [ ] 影片统计
- [ ] 写真管理
  - [ ] 写真CRUD
  - [ ] 写真搜索
  - [ ] 写真分类
- [ ] 合集管理
  - [ ] 合集CRUD
  - [ ] 合集影片关联
- [ ] 下载管理
  - [ ] 下载链接生成
  - [ ] 下载权限验证
  - [ ] 下载统计
  - [ ] 下载限速
- [ ] 评论系统
  - [ ] 评论CRUD
  - [ ] 评论审核
  - [ ] 评论点赞
- [ ] 搜索功能
  - [ ] Elasticsearch集成
  - [ ] 全文搜索
  - [ ] 搜索建议
  - [ ] 搜索统计

#### 爬虫系统 (0%)
- [ ] 爬虫框架搭建
- [ ] YTS爬虫实现
- [ ] VIP资源爬虫实现
- [ ] 大模型集成
  - [ ] 内容理解与分类
  - [ ] 自动标签生成
  - [ ] 内容质量评估
- [ ] 爬虫调度系统
- [ ] 数据清洗与去重
- [ ] 反爬虫策略

#### 文件存储 (0%)
- [ ] MinIO/OSS集成
- [ ] 文件上传接口
- [ ] 文件下载接口
- [ ] 图片处理(缩略图、水印)
- [ ] CDN集成

#### 缓存系统 (0%)
- [ ] Redis集成
- [ ] 缓存策略设计
- [ ] 热点数据缓存
- [ ] 缓存更新机制
- [ ] 缓存穿透/雪崩防护

#### 消息队列 (0%)
- [ ] RabbitMQ/Kafka集成
- [ ] 异步任务处理
- [ ] 消息通知
- [ ] 爬虫任务队列

#### 支付系统 (0%)
- [ ] 支付宝集成
- [ ] 微信支付集成
- [ ] 订单管理
- [ ] 支付回调处理
- [ ] 退款处理

#### 管理后台 (0%)
- [ ] 用户管理接口
- [ ] 内容管理接口
- [ ] 系统配置接口
- [ ] 数据统计接口
- [ ] 日志查询接口

#### 监控与运维 (0%)
- [ ] Spring Boot Actuator配置
- [ ] Prometheus指标导出
- [ ] 日志收集(ELK)
- [ ] 性能监控
- [ ] 告警配置

#### 测试 (0%)
- [ ] 单元测试
- [ ] 集成测试
- [ ] 接口测试
- [ ] 性能测试
- [ ] 安全测试

#### 文档 (0%)
- [ ] Swagger/OpenAPI文档
- [ ] 数据库设计文档
- [ ] 部署文档
- [ ] 运维手册

---


## 5. 详细开发任务

### 5.1 第一阶段:后端基础架构搭建 (预计2周)

#### 任务5.1.1: 项目初始化 (2天)
**负责人**: 后端开发  
**优先级**: P0 (最高)

**详细步骤**:
1. 创建Spring Boot项目(使用Spring Initializr)
   - 选择Java 17
   - 选择Spring Boot 3.2.x
   - 添加依赖: Web, JPA, MySQL, Redis, Security, Validation
2. 配置Maven/Gradle构建文件
3. 配置多环境(dev, test, prod)
   - application.yml
   - application-dev.yml
   - application-test.yml
   - application-prod.yml
4. 配置日志系统(Logback)
5. 配置统一异常处理
6. 配置统一响应格式
7. 配置Swagger/OpenAPI文档

**交付物**:
- 可运行的Spring Boot项目
- 完整的配置文件
- Hello World接口测试通过

#### 任务5.1.2: 数据库设计与初始化 (3天)
**负责人**: 后端开发 + DBA  
**优先级**: P0

**详细步骤**:
1. 设计数据库ER图
2. 创建数据库表结构
   - 用户表(user)
   - 角色表(role)
   - 权限表(permission)
   - 用户角色关联表(user_role)
   - 角色权限关联表(role_permission)
   - 影片表(movie)
   - 写真表(photo)
   - 合集表(collection)
   - 合集影片关联表(collection_movie)
   - 下载记录表(download_record)
   - 评论表(comment)
   - 评分表(rating)
   - 收藏表(favorite)
   - 观看历史表(watch_history)
   - 订单表(order)
   - 支付记录表(payment)
   - 系统配置表(system_config)
   - 爬虫任务表(crawler_task)
   - 爬虫数据表(crawler_data)
3. 创建数据库索引
4. 编写Flyway/Liquibase迁移脚本
5. 初始化基础数据(角色、权限等)

**交付物**:
- 数据库设计文档
- SQL建表脚本
- 数据库迁移脚本
- 初始化数据脚本

#### 任务5.1.3: Redis配置与缓存策略 (2天)
**负责人**: 后端开发  
**优先级**: P0

**详细步骤**:
1. 配置Redis连接
2. 配置Redis序列化
3. 配置Spring Cache
4. 设计缓存Key规范
5. 实现缓存工具类
6. 配置缓存过期策略
7. 实现缓存预热机制

**交付物**:
- Redis配置文件
- 缓存工具类
- 缓存策略文档

#### 任务5.1.4: 安全框架配置 (3天)
**负责人**: 后端开发  
**优先级**: P0

**详细步骤**:
1. 配置Spring Security
2. 实现JWT Token生成与验证
3. 实现刷新Token机制
4. 配置CORS
5. 配置CSRF防护
6. 实现权限拦截器
7. 实现登录失败限制
8. 实现密码加密(BCrypt)

**交付物**:
- Security配置类
- JWT工具类
- 权限拦截器
- 安全配置文档

#### 任务5.1.5: 基础实体类与Repository (2天)
**负责人**: 后端开发  
**优先级**: P0

**详细步骤**:
1. 创建基础实体类(BaseEntity)
2. 创建所有实体类
3. 配置JPA审计(创建时间、更新时间)
4. 创建所有Repository接口
5. 编写基础CRUD方法
6. 编写自定义查询方法

**交付物**:
- 所有实体类
- 所有Repository接口
- 单元测试

### 5.2 第二阶段:核心业务功能开发 (预计4周)

#### 任务5.2.1: 用户认证与授权 (5天)
**负责人**: 后端开发  
**优先级**: P0

**详细步骤**:
1. 实现用户注册接口
   - 邮箱验证
   - 手机验证
   - 用户名唯一性检查
2. 实现用户登录接口
   - 用户名/邮箱/手机登录
   - 密码验证
   - 生成JWT Token
   - 记录登录日志
3. 实现登出接口
   - Token失效
   - 清除Redis缓存
4. 实现刷新Token接口
5. 实现密码找回接口
   - 发送验证码
   - 验证码验证
   - 重置密码
6. 实现修改密码接口
7. 实现社交登录(可选)
   - Google登录
   - GitHub登录

**API接口**:
- POST /api/auth/register - 用户注册
- POST /api/auth/login - 用户登录
- POST /api/auth/logout - 用户登出
- POST /api/auth/refresh - 刷新Token
- POST /api/auth/forgot-password - 忘记密码
- POST /api/auth/reset-password - 重置密码
- POST /api/auth/change-password - 修改密码
- GET /api/auth/profile - 获取用户信息
- PUT /api/auth/profile - 更新用户信息

**交付物**:
- 认证服务类
- 认证控制器
- 单元测试
- 接口文档

#### 任务5.2.2: 用户管理 (3天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 实现用户信息查询接口
2. 实现用户信息更新接口
3. 实现用户头像上传接口
4. 实现用户偏好设置接口
5. 实现用户收藏管理接口
6. 实现用户观看历史接口
7. 实现用户下载历史接口
8. 实现用户统计接口

**API接口**:
- GET /api/users/{id} - 获取用户信息
- PUT /api/users/{id} - 更新用户信息
- POST /api/users/avatar - 上传头像
- GET /api/users/preferences - 获取偏好设置
- PUT /api/users/preferences - 更新偏好设置
- GET /api/users/favorites - 获取收藏列表
- POST /api/users/favorites - 添加收藏
- DELETE /api/users/favorites/{movieId} - 取消收藏
- GET /api/users/watch-history - 获取观看历史
- POST /api/users/watch-history - 添加观看记录
- GET /api/users/download-history - 获取下载历史
- GET /api/users/stats - 获取用户统计

**交付物**:
- 用户服务类
- 用户控制器
- 单元测试
- 接口文档

#### 任务5.2.3: 影片管理 (5天)
**负责人**: 后端开发  
**优先级**: P0

**详细步骤**:
1. 实现影片CRUD接口
   - 创建影片
   - 更新影片
   - 删除影片
   - 查询影片详情
2. 实现影片列表查询接口
   - 分页查询
   - 条件筛选
   - 排序
3. 实现影片分类接口
4. 实现影片搜索接口
5. 实现影片推荐接口
6. 实现影片统计接口
7. 实现影片评分接口
8. 实现影片评论接口

**API接口**:
- GET /api/movies - 影片列表
- GET /api/movies/{id} - 影片详情
- POST /api/movies - 创建影片(管理员)
- PUT /api/movies/{id} - 更新影片(管理员)
- DELETE /api/movies/{id} - 删除影片(管理员)
- GET /api/movies/search - 搜索影片
- GET /api/movies/categories - 获取分类
- GET /api/movies/categories/{id} - 分类影片
- GET /api/movies/recommendations - 推荐影片
- GET /api/movies/{id}/similar - 相似影片
- GET /api/movies/hot - 热门影片
- GET /api/movies/latest - 最新影片
- GET /api/movies/top-rated - 高评分影片
- POST /api/movies/{id}/ratings - 添加评分
- GET /api/movies/{id}/comments - 获取评论
- POST /api/movies/{id}/comments - 添加评论
- GET /api/movies/{id}/stats - 影片统计

**交付物**:
- 影片服务类
- 影片控制器
- 单元测试
- 接口文档

#### 任务5.2.4: 写真管理 (3天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 实现写真CRUD接口
2. 实现写真列表查询接口
3. 实现写真分类接口
4. 实现写真搜索接口
5. 实现写真统计接口

**API接口**:
- GET /api/photos - 写真列表
- GET /api/photos/{id} - 写真详情
- POST /api/photos - 创建写真(管理员)
- PUT /api/photos/{id} - 更新写真(管理员)
- DELETE /api/photos/{id} - 删除写真(管理员)
- GET /api/photos/search - 搜索写真
- GET /api/photos/categories - 获取分类
- GET /api/photos/hot - 热门写真
- GET /api/photos/latest - 最新写真

**交付物**:
- 写真服务类
- 写真控制器
- 单元测试
- 接口文档

#### 任务5.2.5: 合集管理 (3天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 实现合集CRUD接口
2. 实现合集列表查询接口
3. 实现合集影片关联接口
4. 实现合集统计接口

**API接口**:
- GET /api/collections - 合集列表
- GET /api/collections/{id} - 合集详情
- GET /api/collections/{id}/movies - 合集影片
- POST /api/collections - 创建合集(管理员)
- PUT /api/collections/{id} - 更新合集(管理员)
- DELETE /api/collections/{id} - 删除合集(管理员)
- POST /api/collections/{id}/movies - 添加影片到合集
- DELETE /api/collections/{id}/movies/{movieId} - 从合集移除影片

**交付物**:
- 合集服务类
- 合集控制器
- 单元测试
- 接口文档

#### 任务5.2.6: 下载管理 (4天)
**负责人**: 后端开发  
**优先级**: P0

**详细步骤**:
1. 实现下载链接生成接口
   - 权限验证
   - VIP验证
   - 下载次数限制
   - 生成临时下载链接
2. 实现下载记录接口
3. 实现下载统计接口
4. 实现下载队列管理
5. 实现下载限速

**API接口**:
- POST /api/downloads/start - 开始下载
- GET /api/downloads - 下载列表
- GET /api/downloads/{id} - 下载详情
- PUT /api/downloads/{id}/pause - 暂停下载
- PUT /api/downloads/{id}/resume - 恢复下载
- DELETE /api/downloads/{id} - 取消下载
- GET /api/downloads/history - 下载历史
- GET /api/downloads/stats - 下载统计

**交付物**:
- 下载服务类
- 下载控制器
- 单元测试
- 接口文档

#### 任务5.2.7: 评论系统 (3天)
**负责人**: 后端开发  
**优先级**: P2

**详细步骤**:
1. 实现评论CRUD接口
2. 实现评论审核接口
3. 实现评论点赞接口
4. 实现评论回复接口
5. 实现评论举报接口

**API接口**:
- GET /api/movies/{id}/comments - 获取评论
- POST /api/movies/{id}/comments - 添加评论
- PUT /api/comments/{id} - 更新评论
- DELETE /api/comments/{id} - 删除评论
- POST /api/comments/{id}/like - 点赞评论
- POST /api/comments/{id}/reply - 回复评论
- POST /api/comments/{id}/report - 举报评论

**交付物**:
- 评论服务类
- 评论控制器
- 单元测试
- 接口文档

### 5.3 第三阶段:搜索与推荐系统 (预计2周)

#### 任务5.3.1: Elasticsearch集成 (3天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 配置Elasticsearch连接
2. 创建索引映射
3. 实现数据同步机制
4. 实现全文搜索
5. 实现搜索建议
6. 实现高级筛选
7. 实现搜索统计

**交付物**:
- Elasticsearch配置
- 索引映射文件
- 搜索服务类
- 数据同步脚本

#### 任务5.3.2: 推荐算法实现 (4天)
**负责人**: 后端开发 + 算法工程师  
**优先级**: P2

**详细步骤**:
1. 实现基于内容的推荐
   - 相似影片推荐
   - 基于标签推荐
2. 实现协同过滤推荐
   - 用户行为分析
   - 相似用户推荐
3. 实现热门推荐
   - 热度计算算法
   - 时间衰减
4. 实现个性化推荐
   - 用户画像构建
   - 推荐模型训练

**交付物**:
- 推荐服务类
- 推荐算法文档
- 推荐效果评估报告

### 5.4 第四阶段:爬虫系统开发 (预计3周)

#### 任务5.4.1: 爬虫框架搭建 (3天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 设计爬虫架构
2. 实现爬虫基类
3. 实现爬虫调度器
4. 实现爬虫任务队列
5. 实现爬虫数据存储
6. 实现爬虫监控
7. 实现反爬虫策略
   - User-Agent轮换
   - IP代理池
   - 请求频率控制
   - Cookie管理

**交付物**:
- 爬虫框架代码
- 爬虫配置文件
- 爬虫架构文档

#### 任务5.4.2: YTS爬虫实现 (4天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 分析YTS网站结构
2. 实现影片列表爬取
3. 实现影片详情爬取
4. 实现下载链接提取
5. 实现数据清洗
6. 实现数据去重
7. 实现增量更新
8. 实现错误重试

**爬取内容**:
- 影片标题
- 影片海报
- 影片描述
- 影片类型
- 上映年份
- IMDb评分
- 下载链接(多种质量)
- 字幕链接

**交付物**:
- YTS爬虫实现
- 爬虫配置
- 爬取数据样例
- 爬虫运行日志

#### 任务5.4.3: VIP资源爬虫实现 (5天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 确定VIP资源来源网站
2. 分析网站结构
3. 实现登录模拟(如需要)
4. 实现资源列表爬取
5. 实现资源详情爬取
6. 实现下载链接提取
7. 实现数据清洗
8. 实现数据去重
9. 实现增量更新

**交付物**:
- VIP资源爬虫实现
- 爬虫配置
- 爬取数据样例

#### 任务5.4.4: 大模型集成 (5天)
**负责人**: 后端开发 + AI工程师  
**优先级**: P2

**详细步骤**:
1. 选择大模型方案
   - OpenAI GPT-4 API
   - Claude 3 API
   - 本地部署Llama 3
2. 实现大模型调用封装
3. 实现内容理解功能
   - 影片内容分析
   - 自动生成描述
   - 内容分类
4. 实现自动标签生成
5. 实现内容质量评估
6. 实现敏感内容检测
7. 优化Prompt工程

**应用场景**:
- 自动生成影片描述
- 智能分类和打标签
- 内容质量评分
- 敏感内容过滤
- 搜索查询理解
- 推荐理由生成

**交付物**:
- 大模型服务类
- Prompt模板
- 集成文档
- 效果评估报告

### 5.5 第五阶段:文件存储与CDN (预计1周)

#### 任务5.5.1: MinIO/OSS集成 (3天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 配置MinIO/OSS
2. 实现文件上传接口
3. 实现文件下载接口
4. 实现文件删除接口
5. 实现图片处理
   - 缩略图生成
   - 水印添加
   - 格式转换
6. 实现文件访问权限控制

**交付物**:
- 文件存储服务类
- 文件上传接口
- 文件下载接口
- 配置文档

#### 任务5.5.2: CDN集成 (2天)
**负责人**: 后端开发 + 运维  
**优先级**: P2

**详细步骤**:
1. 选择CDN服务商
2. 配置CDN
3. 实现CDN URL生成
4. 实现CDN缓存刷新
5. 配置CDN防盗链

**交付物**:
- CDN配置文档
- CDN服务类

### 5.6 第六阶段:支付系统 (预计1周)

#### 任务5.6.1: 支付宝集成 (3天)
**负责人**: 后端开发  
**优先级**: P2

**详细步骤**:
1. 申请支付宝商户账号
2. 配置支付宝SDK
3. 实现支付接口
4. 实现支付回调处理
5. 实现订单管理
6. 实现退款接口

**交付物**:
- 支付服务类
- 支付接口
- 回调处理
- 订单管理

#### 任务5.6.2: 微信支付集成 (2天)
**负责人**: 后端开发  
**优先级**: P2

**详细步骤**:
1. 申请微信商户账号
2. 配置微信支付SDK
3. 实现支付接口
4. 实现支付回调处理
5. 实现退款接口

**交付物**:
- 微信支付服务类
- 支付接口
- 回调处理

### 5.7 第七阶段:管理后台 (预计2周)

#### 任务5.7.1: 用户管理后台 (3天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 实现用户列表查询
2. 实现用户详情查询
3. 实现用户创建
4. 实现用户更新
5. 实现用户删除
6. 实现用户激活/停用
7. 实现用户角色管理
8. 实现用户权限管理

**API接口**:
- GET /api/admin/users - 用户列表
- GET /api/admin/users/{id} - 用户详情
- POST /api/admin/users - 创建用户
- PUT /api/admin/users/{id} - 更新用户
- DELETE /api/admin/users/{id} - 删除用户
- PUT /api/admin/users/{id}/activate - 激活用户
- PUT /api/admin/users/{id}/deactivate - 停用用户
- PUT /api/admin/users/{id}/roles - 设置用户角色

**交付物**:
- 管理后台用户服务
- 管理后台用户控制器
- 接口文档

#### 任务5.7.2: 内容管理后台 (4天)
**负责人**: 后端开发  
**优先级**: P1

**详细步骤**:
1. 实现影片管理接口
2. 实现写真管理接口
3. 实现合集管理接口
4. 实现批量上传接口
5. 实现内容审核接口
6. 实现内容统计接口

**API接口**:
- GET /api/admin/movies - 影片列表
- POST /api/admin/movies - 创建影片
- PUT /api/admin/movies/{id} - 更新影片
- DELETE /api/admin/movies/{id} - 删除影片
- PUT /api/admin/movies/{id}/approve - 审核通过
- PUT /api/admin/movies/{id}/reject - 审核拒绝
- POST /api/admin/movies/bulk-upload - 批量上传
- GET /api/admin/content/pending - 待审核内容

**交付物**:
- 内容管理服务
- 内容管理控制器
- 接口文档

#### 任务5.7.3: 系统管理后台 (3天)
**负责人**: 后端开发  
**优先级**: P2

**详细步骤**:
1. 实现系统配置接口
2. 实现系统监控接口
3. 实现日志查询接口
4. 实现数据统计接口
5. 实现爬虫管理接口

**API接口**:
- GET /api/admin/config - 系统配置
- PUT /api/admin/config - 更新配置
- GET /api/admin/system/stats - 系统统计
- GET /api/admin/system/status - 服务器状态
- GET /api/admin/system/logs - 系统日志
- GET /api/admin/analytics - 数据分析
- GET /api/admin/crawler/tasks - 爬虫任务
- POST /api/admin/crawler/tasks - 创建爬虫任务

**交付物**:
- 系统管理服务
- 系统管理控制器
- 接口文档

### 5.8 第八阶段:监控与运维 (预计1周)

#### 任务5.8.1: 监控系统搭建 (3天)
**负责人**: 后端开发 + 运维  
**优先级**: P2

**详细步骤**:
1. 配置Spring Boot Actuator
2. 配置Prometheus
3. 配置Grafana
4. 创建监控面板
5. 配置告警规则
6. 配置ELK日志收集

**交付物**:
- 监控配置文件
- Grafana面板
- 告警规则
- 监控文档

#### 任务5.8.2: 性能优化 (2天)
**负责人**: 后端开发  
**优先级**: P2

**详细步骤**:
1. 数据库查询优化
2. 缓存策略优化
3. 接口性能测试
4. 慢查询优化
5. 连接池优化

**交付物**:
- 性能测试报告
- 优化方案文档

### 5.9 第九阶段:测试与部署 (预计1周)

#### 任务5.9.1: 测试 (3天)
**负责人**: 测试工程师 + 开发  
**优先级**: P0

**详细步骤**:
1. 单元测试
2. 集成测试
3. 接口测试
4. 性能测试
5. 安全测试
6. 压力测试

**交付物**:
- 测试用例
- 测试报告
- Bug列表

#### 任务5.9.2: 部署 (2天)
**负责人**: 运维 + 开发  
**优先级**: P0

**详细步骤**:
1. 准备生产环境
2. 配置Nginx
3. 配置SSL证书
4. 部署后端服务
5. 部署前端应用
6. 配置域名解析
7. 配置防火墙
8. 配置备份策略

**交付物**:
- 部署文档
- 运维手册
- 备份方案

---


## 6. API接口文档

### 6.1 API设计原则

1. **RESTful风格**: 使用标准HTTP方法(GET, POST, PUT, DELETE)
2. **统一响应格式**: 所有接口返回统一的JSON格式
3. **版本控制**: API路径包含版本号(/api/v1/)
4. **错误处理**: 统一的错误码和错误信息
5. **分页规范**: 统一的分页参数和响应格式
6. **认证方式**: JWT Token认证
7. **HTTPS**: 生产环境强制使用HTTPS

### 6.2 统一响应格式

#### 成功响应
```json
{
  "code": 200,
  "message": "success",
  "data": {
    // 业务数据
  },
  "timestamp": 1698345600000
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "参数错误",
  "error": "用户名不能为空",
  "timestamp": 1698345600000
}
```

#### 分页响应
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  },
  "timestamp": 1698345600000
}
```

### 6.3 错误码定义

| 错误码 | 说明 | HTTP状态码 |
|--------|------|-----------|
| 200 | 成功 | 200 |
| 400 | 请求参数错误 | 400 |
| 401 | 未认证 | 401 |
| 403 | 无权限 | 403 |
| 404 | 资源不存在 | 404 |
| 409 | 资源冲突 | 409 |
| 429 | 请求过于频繁 | 429 |
| 500 | 服务器内部错误 | 500 |
| 1001 | 用户名已存在 | 400 |
| 1002 | 邮箱已存在 | 400 |
| 1003 | 密码错误 | 400 |
| 1004 | 用户不存在 | 404 |
| 1005 | Token已过期 | 401 |
| 1006 | Token无效 | 401 |
| 2001 | 影片不存在 | 404 |
| 2002 | 影片已下架 | 403 |
| 3001 | VIP权限不足 | 403 |
| 3002 | 下载次数已用完 | 403 |
| 4001 | 支付失败 | 400 |
| 4002 | 订单不存在 | 404 |

### 6.4 核心API接口

#### 6.4.1 认证接口

##### 用户注册
```
POST /api/auth/register
Content-Type: application/json

Request:
{
  "username": "string",
  "email": "string",
  "password": "string",
  "confirmPassword": "string"
}

Response:
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "userId": 1,
    "username": "string",
    "email": "string",
    "token": "string",
    "refreshToken": "string"
  }
}
```

##### 用户登录
```
POST /api/auth/login
Content-Type: application/json

Request:
{
  "username": "string",  // 用户名/邮箱/手机号
  "password": "string"
}

Response:
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": 1,
    "username": "string",
    "email": "string",
    "role": "USER",
    "isVip": false,
    "token": "string",
    "refreshToken": "string",
    "expiresIn": 3600
  }
}
```

##### 刷新Token
```
POST /api/auth/refresh
Content-Type: application/json

Request:
{
  "refreshToken": "string"
}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "string",
    "refreshToken": "string",
    "expiresIn": 3600
  }
}
```

#### 6.4.2 影片接口

##### 影片列表
```
GET /api/movies?page=1&pageSize=20&category=action&sort=latest
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "title": "string",
        "description": "string",
        "imageUrl": "string",
        "rating": "7.5",
        "year": 2024,
        "genres": ["动作", "科幻"],
        "quality": "1080p",
        "isVip": false,
        "isNew": true,
        "viewCount": 1000,
        "downloadCount": 500
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

##### 影片详情
```
GET /api/movies/{id}
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "title": "string",
    "originalTitle": "string",
    "description": "string",
    "poster": "string",
    "backdrop": "string",
    "trailer": "string",
    "genres": ["动作", "科幻"],
    "duration": 120,
    "releaseDate": "2024-01-01",
    "rating": "7.5",
    "doubanRating": "7.5",
    "imdbRating": 7.8,
    "tmdbRating": 7.6,
    "director": "string",
    "cast": ["演员1", "演员2"],
    "country": "美国",
    "language": "英语",
    "subtitles": ["中文", "英文"],
    "quality": ["4K", "1080p", "720p"],
    "fileSize": 10737418240,
    "downloadLinks": [
      {
        "id": 1,
        "name": "4K版本",
        "url": "string",
        "size": "10GB",
        "format": "MKV",
        "quality": "4K",
        "isVip": true
      }
    ],
    "screenshots": [
      {
        "url": "string",
        "alt": "string"
      }
    ],
    "recommendations": [],
    "viewCount": 1000,
    "downloadCount": 500,
    "favoriteCount": 200,
    "commentCount": 50,
    "isVip": false,
    "isFavorited": false
  }
}
```

##### 搜索影片
```
GET /api/movies/search?q=keyword&page=1&pageSize=20
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [],
    "pagination": {},
    "suggestions": ["关键词1", "关键词2"]
  }
}
```

#### 6.4.3 下载接口

##### 开始下载
```
POST /api/downloads/start
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "movieId": 1,
  "quality": "1080p"
}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "downloadId": 1,
    "downloadUrl": "string",  // 临时下载链接
    "expiresIn": 3600,        // 链接有效期(秒)
    "fileSize": 10737418240,
    "fileName": "string"
  }
}
```

##### 下载列表
```
GET /api/downloads?status=downloading&page=1&pageSize=20
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "movieId": 1,
        "movieTitle": "string",
        "quality": "1080p",
        "fileSize": 10737418240,
        "downloadedSize": 5368709120,
        "progress": 50,
        "status": "downloading",  // downloading, paused, completed, failed
        "speed": 1048576,         // 字节/秒
        "remainingTime": 3600,    // 秒
        "createdAt": "2024-01-01T00:00:00Z",
        "updatedAt": "2024-01-01T00:00:00Z"
      }
    ],
    "pagination": {}
  }
}
```

#### 6.4.4 用户接口

##### 获取用户信息
```
GET /api/users/{id}
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "string",
    "email": "string",
    "avatar": "string",
    "role": "USER",
    "isVip": false,
    "vipExpireDate": null,
    "downloadLimit": 10,
    "downloadUsed": 5,
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

##### 用户收藏列表
```
GET /api/users/favorites?page=1&pageSize=20
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [],
    "pagination": {}
  }
}
```

##### 添加收藏
```
POST /api/users/favorites
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "movieId": 1
}

Response:
{
  "code": 200,
  "message": "收藏成功"
}
```

#### 6.4.5 管理后台接口

##### 用户管理列表
```
GET /api/admin/users?page=1&pageSize=20&role=USER&status=active
Authorization: Bearer {admin_token}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "username": "string",
        "email": "string",
        "role": "USER",
        "isVip": false,
        "status": "active",
        "createdAt": "2024-01-01T00:00:00Z",
        "lastLoginAt": "2024-01-01T00:00:00Z"
      }
    ],
    "pagination": {}
  }
}
```

##### 创建影片
```
POST /api/admin/movies
Authorization: Bearer {admin_token}
Content-Type: application/json

Request:
{
  "title": "string",
  "originalTitle": "string",
  "description": "string",
  "poster": "string",
  "backdrop": "string",
  "trailer": "string",
  "genres": ["动作", "科幻"],
  "duration": 120,
  "releaseDate": "2024-01-01",
  "director": "string",
  "cast": ["演员1", "演员2"],
  "country": "美国",
  "language": "英语",
  "subtitles": ["中文", "英文"],
  "quality": ["4K", "1080p"],
  "isVip": false,
  "downloadLinks": [
    {
      "name": "4K版本",
      "url": "string",
      "size": "10GB",
      "format": "MKV",
      "quality": "4K"
    }
  ]
}

Response:
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 1
  }
}
```

### 6.5 API认证

所有需要认证的接口都需要在请求头中携带JWT Token:

```
Authorization: Bearer {token}
```

Token格式:
```json
{
  "userId": 1,
  "username": "string",
  "role": "USER",
  "exp": 1698345600
}
```

### 6.6 API限流

为防止滥用,API实施以下限流策略:

| 用户类型 | 限流规则 |
|---------|---------|
| 游客 | 100次/小时 |
| 注册用户 | 1000次/小时 |
| VIP用户 | 10000次/小时 |
| 管理员 | 无限制 |

超过限流后返回429错误:
```json
{
  "code": 429,
  "message": "请求过于频繁,请稍后再试",
  "retryAfter": 3600
}
```

---


## 7. 爬虫系统设计

### 7.1 爬虫系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    爬虫调度中心                          │
│  - 任务调度                                              │
│  - 任务监控                                              │
│  - 任务重试                                              │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼────────┐ ┌──────▼──────┐ ┌───────▼────────┐
│  YTS爬虫       │ │ VIP资源爬虫  │ │  其他爬虫      │
│  - 免费资源    │ │ - 付费资源   │ │  - 扩展资源    │
└───────┬────────┘ └──────┬──────┘ └───────┬────────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          │
        ┌─────────────────▼─────────────────┐
        │          大模型处理层              │
        │  - 内容理解                        │
        │  - 自动分类                        │
        │  - 标签生成                        │
        │  - 质量评估                        │
        └─────────────────┬─────────────────┘
                          │
        ┌─────────────────▼─────────────────┐
        │          数据处理层                │
        │  - 数据清洗                        │
        │  - 数据去重                        │
        │  - 数据验证                        │
        │  - 数据转换                        │
        └─────────────────┬─────────────────┘
                          │
        ┌─────────────────▼─────────────────┐
        │          数据存储层                │
        │  - MySQL(结构化数据)               │
        │  - Redis(缓存)                     │
        │  - Elasticsearch(搜索)             │
        └───────────────────────────────────┘
```

### 7.2 YTS爬虫详细设计

#### 7.2.1 目标网站分析

**网站**: https://yts.mx/  
**特点**:
- 提供高质量的电影资源
- 多种分辨率(720p, 1080p, 2160p)
- 包含IMDb评分和详细信息
- 提供种子文件和磁力链接

#### 7.2.2 爬取策略

**爬取频率**:
- 新片列表: 每小时爬取一次
- 热门列表: 每6小时爬取一次
- 详情页: 发现新片时立即爬取
- 增量更新: 每天凌晨全量检查

**爬取内容**:
1. 影片列表页
   - 影片ID
   - 影片标题
   - 海报URL
   - 上映年份
   - IMDb评分
   - 类型标签

2. 影片详情页
   - 完整标题
   - 原始标题
   - 详细描述
   - 导演
   - 演员列表
   - 类型
   - 时长
   - 语言
   - 字幕
   - 下载链接(多种质量)
   - 截图
   - 相关推荐

#### 7.2.3 技术实现

```java
@Service
public class YTSCrawlerService {
    
    @Autowired
    private WebDriver webDriver;
    
    @Autowired
    private MovieRepository movieRepository;
    
    @Autowired
    private AIService aiService;
    
    /**
     * 爬取影片列表
     */
    public List<MovieDTO> crawlMovieList(int page) {
        String url = "https://yts.mx/browse-movies?page=" + page;
        
        // 1. 访问列表页
        webDriver.get(url);
        
        // 2. 解析影片列表
        List<WebElement> movieElements = webDriver.findElements(
            By.cssSelector(".browse-movie-wrap")
        );
        
        List<MovieDTO> movies = new ArrayList<>();
        for (WebElement element : movieElements) {
            MovieDTO movie = parseMovieElement(element);
            movies.add(movie);
        }
        
        return movies;
    }
    
    /**
     * 爬取影片详情
     */
    public MovieDetail crawlMovieDetail(String movieId) {
        String url = "https://yts.mx/movies/" + movieId;
        
        // 1. 访问详情页
        webDriver.get(url);
        
        // 2. 解析影片详情
        MovieDetail detail = new MovieDetail();
        detail.setTitle(getElementText(".movie-title"));
        detail.setDescription(getElementText("#synopsis"));
        detail.setDirector(getElementText(".director"));
        // ... 更多字段解析
        
        // 3. 解析下载链接
        List<DownloadLink> links = parseDownloadLinks();
        detail.setDownloadLinks(links);
        
        // 4. 使用AI增强数据
        enhanceWithAI(detail);
        
        return detail;
    }
    
    /**
     * 使用AI增强数据
     */
    private void enhanceWithAI(MovieDetail detail) {
        // 1. 生成中文描述
        String chineseDesc = aiService.translate(detail.getDescription());
        detail.setChineseDescription(chineseDesc);
        
        // 2. 自动生成标签
        List<String> tags = aiService.generateTags(detail);
        detail.setTags(tags);
        
        // 3. 内容质量评估
        double qualityScore = aiService.assessQuality(detail);
        detail.setQualityScore(qualityScore);
        
        // 4. 敏感内容检测
        boolean isSafe = aiService.checkContent(detail);
        detail.setIsSafe(isSafe);
    }
}
```

#### 7.2.4 反爬虫策略

1. **User-Agent轮换**
```java
private static final List<String> USER_AGENTS = Arrays.asList(
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
    "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36"
);

private String getRandomUserAgent() {
    return USER_AGENTS.get(new Random().nextInt(USER_AGENTS.size()));
}
```

2. **请求频率控制**
```java
@Component
public class RateLimiter {
    private static final long MIN_INTERVAL = 2000; // 2秒
    private long lastRequestTime = 0;
    
    public synchronized void waitIfNeeded() {
        long now = System.currentTimeMillis();
        long elapsed = now - lastRequestTime;
        
        if (elapsed < MIN_INTERVAL) {
            try {
                Thread.sleep(MIN_INTERVAL - elapsed);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
        
        lastRequestTime = System.currentTimeMillis();
    }
}
```

3. **IP代理池**
```java
@Service
public class ProxyService {
    private List<Proxy> proxyList = new ArrayList<>();
    private int currentIndex = 0;
    
    public Proxy getNextProxy() {
        if (proxyList.isEmpty()) {
            loadProxies();
        }
        
        Proxy proxy = proxyList.get(currentIndex);
        currentIndex = (currentIndex + 1) % proxyList.size();
        
        return proxy;
    }
    
    private void loadProxies() {
        // 从代理服务商获取代理列表
        // 或使用免费代理池
    }
}
```

4. **Cookie管理**
```java
@Service
public class CookieManager {
    private Map<String, String> cookies = new HashMap<>();
    
    public void saveCookies(Set<Cookie> cookieSet) {
        for (Cookie cookie : cookieSet) {
            cookies.put(cookie.getName(), cookie.getValue());
        }
    }
    
    public void loadCookies(WebDriver driver) {
        for (Map.Entry<String, String> entry : cookies.entrySet()) {
            Cookie cookie = new Cookie(entry.getKey(), entry.getValue());
            driver.manage().addCookie(cookie);
        }
    }
}
```

### 7.3 VIP资源爬虫设计

#### 7.3.1 目标网站选择

**候选网站**:
1. 高清影视网站
2. 蓝光原盘资源站
3. PT站点(需要账号)
4. 字幕组网站

**选择标准**:
- 资源质量高
- 更新及时
- 稳定性好
- 反爬虫难度适中

#### 7.3.2 爬取策略

**登录处理**:
```java
@Service
public class VIPCrawlerService {
    
    /**
     * 模拟登录
     */
    public boolean login(String username, String password) {
        webDriver.get("https://example.com/login");
        
        // 填写表单
        webDriver.findElement(By.id("username")).sendKeys(username);
        webDriver.findElement(By.id("password")).sendKeys(password);
        
        // 处理验证码(如果有)
        if (hasCaptcha()) {
            String captcha = solveCaptcha();
            webDriver.findElement(By.id("captcha")).sendKeys(captcha);
        }
        
        // 提交登录
        webDriver.findElement(By.id("submit")).click();
        
        // 验证登录成功
        return isLoginSuccessful();
    }
    
    /**
     * 验证码识别
     */
    private String solveCaptcha() {
        // 1. 截取验证码图片
        WebElement captchaImg = webDriver.findElement(By.id("captcha-img"));
        File screenshot = captchaImg.getScreenshotAs(OutputType.FILE);
        
        // 2. 使用OCR识别
        String captcha = ocrService.recognize(screenshot);
        
        // 3. 或使用打码平台
        // String captcha = captchaService.solve(screenshot);
        
        return captcha;
    }
}
```

**数据加密处理**:
```java
/**
 * 处理加密的下载链接
 */
private String decryptDownloadLink(String encryptedLink) {
    // 1. 分析加密算法
    // 2. 实现解密逻辑
    // 3. 返回真实下载链接
    
    return decryptedLink;
}
```

### 7.4 大模型集成

#### 7.4.1 OpenAI GPT-4集成

```java
@Service
public class OpenAIService {
    
    @Value("${openai.api.key}")
    private String apiKey;
    
    @Value("${openai.api.url}")
    private String apiUrl;
    
    /**
     * 生成影片描述
     */
    public String generateDescription(MovieDetail movie) {
        String prompt = String.format(
            "请为以下电影生成一段吸引人的中文描述(200字以内):\n" +
            "标题: %s\n" +
            "类型: %s\n" +
            "导演: %s\n" +
            "演员: %s\n" +
            "原始描述: %s",
            movie.getTitle(),
            String.join(", ", movie.getGenres()),
            movie.getDirector(),
            String.join(", ", movie.getCast()),
            movie.getDescription()
        );
        
        return callGPT4(prompt);
    }
    
    /**
     * 自动生成标签
     */
    public List<String> generateTags(MovieDetail movie) {
        String prompt = String.format(
            "请为以下电影生成5-10个相关标签(中文):\n" +
            "标题: %s\n" +
            "类型: %s\n" +
            "描述: %s\n" +
            "要求: 标签要准确、简洁,用逗号分隔",
            movie.getTitle(),
            String.join(", ", movie.getGenres()),
            movie.getDescription()
        );
        
        String response = callGPT4(prompt);
        return Arrays.asList(response.split(","));
    }
    
    /**
     * 内容质量评估
     */
    public double assessQuality(MovieDetail movie) {
        String prompt = String.format(
            "请评估以下电影的内容质量(0-10分):\n" +
            "标题: %s\n" +
            "IMDb评分: %.1f\n" +
            "类型: %s\n" +
            "导演: %s\n" +
            "描述: %s\n" +
            "要求: 只返回数字分数",
            movie.getTitle(),
            movie.getImdbRating(),
            String.join(", ", movie.getGenres()),
            movie.getDirector(),
            movie.getDescription()
        );
        
        String response = callGPT4(prompt);
        return Double.parseDouble(response.trim());
    }
    
    /**
     * 敏感内容检测
     */
    public boolean checkContent(MovieDetail movie) {
        String prompt = String.format(
            "请检测以下电影内容是否包含敏感信息(暴力、色情、政治等):\n" +
            "标题: %s\n" +
            "描述: %s\n" +
            "要求: 只返回 'safe' 或 'unsafe'",
            movie.getTitle(),
            movie.getDescription()
        );
        
        String response = callGPT4(prompt);
        return "safe".equalsIgnoreCase(response.trim());
    }
    
    /**
     * 调用GPT-4 API
     */
    private String callGPT4(String prompt) {
        // 构建请求
        Map<String, Object> request = new HashMap<>();
        request.put("model", "gpt-4");
        request.put("messages", Arrays.asList(
            Map.of("role", "user", "content", prompt)
        ));
        request.put("temperature", 0.7);
        request.put("max_tokens", 500);
        
        // 发送请求
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", "Bearer " + apiKey);
        headers.setContentType(MediaType.APPLICATION_JSON);
        
        HttpEntity<Map<String, Object>> entity = new HttpEntity<>(request, headers);
        
        RestTemplate restTemplate = new RestTemplate();
        ResponseEntity<Map> response = restTemplate.postForEntity(
            apiUrl,
            entity,
            Map.class
        );
        
        // 解析响应
        Map<String, Object> body = response.getBody();
        List<Map<String, Object>> choices = (List<Map<String, Object>>) body.get("choices");
        Map<String, Object> message = (Map<String, Object>) choices.get(0).get("message");
        
        return (String) message.get("content");
    }
}
```

#### 7.4.2 本地大模型部署(Llama 3)

```java
@Service
public class LocalLLMService {
    
    @Value("${llm.local.url}")
    private String localLLMUrl;
    
    /**
     * 调用本地大模型
     */
    public String callLocalLLM(String prompt) {
        // 使用Ollama或vLLM部署的本地模型
        Map<String, Object> request = new HashMap<>();
        request.put("model", "llama3");
        request.put("prompt", prompt);
        request.put("stream", false);
        
        RestTemplate restTemplate = new RestTemplate();
        ResponseEntity<Map> response = restTemplate.postForEntity(
            localLLMUrl + "/api/generate",
            request,
            Map.class
        );
        
        Map<String, Object> body = response.getBody();
        return (String) body.get("response");
    }
}
```

### 7.5 爬虫调度系统

#### 7.5.1 定时任务配置

```java
@Configuration
@EnableScheduling
public class CrawlerScheduleConfig {
    
    @Autowired
    private YTSCrawlerService ytsCrawlerService;
    
    @Autowired
    private VIPCrawlerService vipCrawlerService;
    
    /**
     * YTS新片爬取 - 每小时执行
     */
    @Scheduled(cron = "0 0 * * * ?")
    public void crawlYTSNewMovies() {
        log.info("开始爬取YTS新片...");
        ytsCrawlerService.crawlNewMovies();
    }
    
    /**
     * YTS热门爬取 - 每6小时执行
     */
    @Scheduled(cron = "0 0 */6 * * ?")
    public void crawlYTSHotMovies() {
        log.info("开始爬取YTS热门影片...");
        ytsCrawlerService.crawlHotMovies();
    }
    
    /**
     * VIP资源爬取 - 每天凌晨2点执行
     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void crawlVIPResources() {
        log.info("开始爬取VIP资源...");
        vipCrawlerService.crawlResources();
    }
    
    /**
     * 数据清理 - 每天凌晨4点执行
     */
    @Scheduled(cron = "0 0 4 * * ?")
    public void cleanupData() {
        log.info("开始清理过期数据...");
        // 清理过期的下载链接
        // 清理无效的影片数据
        // 清理重复数据
    }
}
```

#### 7.5.2 任务队列管理

```java
@Service
public class CrawlerTaskQueue {
    
    @Autowired
    private RedisTemplate<String, CrawlerTask> redisTemplate;
    
    private static final String QUEUE_KEY = "crawler:task:queue";
    private static final String PROCESSING_KEY = "crawler:task:processing";
    
    /**
     * 添加任务到队列
     */
    public void addTask(CrawlerTask task) {
        redisTemplate.opsForList().rightPush(QUEUE_KEY, task);
    }
    
    /**
     * 获取下一个任务
     */
    public CrawlerTask getNextTask() {
        CrawlerTask task = redisTemplate.opsForList().leftPop(QUEUE_KEY);
        if (task != null) {
            // 移到处理中队列
            redisTemplate.opsForHash().put(
                PROCESSING_KEY,
                task.getId(),
                task
            );
        }
        return task;
    }
    
    /**
     * 标记任务完成
     */
    public void completeTask(String taskId) {
        redisTemplate.opsForHash().delete(PROCESSING_KEY, taskId);
    }
    
    /**
     * 任务失败重试
     */
    public void retryTask(CrawlerTask task) {
        task.incrementRetryCount();
        if (task.getRetryCount() < 3) {
            // 重新加入队列
            addTask(task);
        } else {
            // 标记为失败
            task.setStatus(TaskStatus.FAILED);
            saveFailedTask(task);
        }
    }
}
```

### 7.6 数据去重策略

```java
@Service
public class DataDeduplicationService {
    
    @Autowired
    private MovieRepository movieRepository;
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * 检查影片是否已存在
     */
    public boolean isDuplicate(MovieDTO movie) {
        // 1. 先查Redis缓存
        String cacheKey = "movie:hash:" + generateHash(movie);
        if (redisTemplate.hasKey(cacheKey)) {
            return true;
        }
        
        // 2. 查数据库
        boolean exists = movieRepository.existsByTitleAndYear(
            movie.getTitle(),
            movie.getYear()
        );
        
        if (exists) {
            // 缓存结果
            redisTemplate.opsForValue().set(
                cacheKey,
                "1",
                Duration.ofDays(7)
            );
        }
        
        return exists;
    }
    
    /**
     * 生成影片哈希值
     */
    private String generateHash(MovieDTO movie) {
        String data = movie.getTitle() + movie.getYear();
        return DigestUtils.md5DigestAsHex(data.getBytes());
    }
    
    /**
     * 合并重复数据
     */
    public void mergeDuplicates() {
        // 1. 查找重复影片
        List<Movie> duplicates = movieRepository.findDuplicates();
        
        // 2. 合并数据
        for (Movie movie : duplicates) {
            List<Movie> similarMovies = movieRepository.findSimilar(
                movie.getTitle(),
                movie.getYear()
            );
            
            if (similarMovies.size() > 1) {
                Movie merged = mergeMovies(similarMovies);
                movieRepository.save(merged);
                
                // 删除重复项
                for (Movie similar : similarMovies) {
                    if (!similar.getId().equals(merged.getId())) {
                        movieRepository.delete(similar);
                    }
                }
            }
        }
    }
}
```

---


## 8. 开发周期估算

### 8.1 总体时间规划

| 阶段 | 任务 | 预计工期 | 人力配置 |
|------|------|---------|---------|
| 第一阶段 | 后端基础架构搭建 | 2周 | 2名后端开发 |
| 第二阶段 | 核心业务功能开发 | 4周 | 2名后端开发 |
| 第三阶段 | 搜索与推荐系统 | 2周 | 1名后端开发 + 1名算法工程师 |
| 第四阶段 | 爬虫系统开发 | 3周 | 2名后端开发 |
| 第五阶段 | 文件存储与CDN | 1周 | 1名后端开发 + 1名运维 |
| 第六阶段 | 支付系统 | 1周 | 1名后端开发 |
| 第七阶段 | 管理后台 | 2周 | 1名后端开发 + 1名前端开发 |
| 第八阶段 | 监控与运维 | 1周 | 1名后端开发 + 1名运维 |
| 第九阶段 | 测试与部署 | 1周 | 全员 |
| **总计** | **全部功能** | **17周(约4个月)** | **2-3名后端 + 1名前端 + 1名运维** |

### 8.2 详细时间分解

#### 8.2.1 第一阶段:后端基础架构(2周)

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| 项目初始化 | 2天 | 后端开发A |
| 数据库设计与初始化 | 3天 | 后端开发A + DBA |
| Redis配置与缓存策略 | 2天 | 后端开发B |
| 安全框架配置 | 3天 | 后端开发A |
| 基础实体类与Repository | 2天 | 后端开发B |
| **小计** | **10工作日** | **2人** |

#### 8.2.2 第二阶段:核心业务功能(4周)

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| 用户认证与授权 | 5天 | 后端开发A |
| 用户管理 | 3天 | 后端开发B |
| 影片管理 | 5天 | 后端开发A |
| 写真管理 | 3天 | 后端开发B |
| 合集管理 | 3天 | 后端开发A |
| 下载管理 | 4天 | 后端开发B |
| 评论系统 | 3天 | 后端开发A |
| **小计** | **20工作日** | **2人** |

#### 8.2.3 第三阶段:搜索与推荐(2周)

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| Elasticsearch集成 | 3天 | 后端开发A |
| 推荐算法实现 | 4天 | 算法工程师 |
| 搜索优化 | 2天 | 后端开发A |
| 推荐效果调优 | 3天 | 算法工程师 |
| **小计** | **10工作日** | **1后端 + 1算法** |

#### 8.2.4 第四阶段:爬虫系统(3周)

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| 爬虫框架搭建 | 3天 | 后端开发A |
| YTS爬虫实现 | 4天 | 后端开发B |
| VIP资源爬虫实现 | 5天 | 后端开发A |
| 大模型集成 | 5天 | 后端开发B + AI工程师 |
| 调度系统与监控 | 3天 | 后端开发A |
| **小计** | **15工作日** | **2人** |

#### 8.2.5 第五阶段:文件存储与CDN(1周)

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| MinIO/OSS集成 | 3天 | 后端开发A |
| CDN集成 | 2天 | 后端开发A + 运维 |
| **小计** | **5工作日** | **1后端 + 1运维** |

#### 8.2.6 第六阶段:支付系统(1周)

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| 支付宝集成 | 3天 | 后端开发A |
| 微信支付集成 | 2天 | 后端开发A |
| **小计** | **5工作日** | **1人** |

#### 8.2.7 第七阶段:管理后台(2周)

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| 用户管理后台 | 3天 | 后端开发A |
| 内容管理后台 | 4天 | 后端开发A |
| 系统管理后台 | 3天 | 后端开发A |
| 前端页面完善 | 5天 | 前端开发 |
| **小计** | **10工作日** | **1后端 + 1前端** |

#### 8.2.8 第八阶段:监控与运维(1周)

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| 监控系统搭建 | 3天 | 后端开发 + 运维 |
| 性能优化 | 2天 | 后端开发 |
| **小计** | **5工作日** | **1后端 + 1运维** |

#### 8.2.9 第九阶段:测试与部署(1周)

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| 测试 | 3天 | 测试工程师 + 全员 |
| 部署 | 2天 | 运维 + 后端开发 |
| **小计** | **5工作日** | **全员** |

### 8.3 前端开发时间规划

前端大部分工作已完成,剩余工作估算:

| 任务 | 工作日 | 负责人 |
|------|--------|--------|
| 搜索页面完善 | 2天 | 前端开发 |
| 分类页面完善 | 2天 | 前端开发 |
| 下载管理器 | 3天 | 前端开发 |
| 播放器集成 | 2天 | 前端开发 |
| 支付页面 | 2天 | 前端开发 |
| 性能优化 | 2天 | 前端开发 |
| 测试完善 | 3天 | 前端开发 |
| **小计** | **16工作日(约3周)** | **1人** |

### 8.4 关键里程碑

| 里程碑 | 时间节点 | 交付内容 |
|--------|---------|---------|
| M1: 基础架构完成 | 第2周末 | 后端项目可运行,数据库就绪 |
| M2: 核心功能完成 | 第6周末 | 用户、影片、下载等核心功能可用 |
| M3: 搜索推荐完成 | 第8周末 | 搜索和推荐系统上线 |
| M4: 爬虫系统完成 | 第11周末 | 自动爬取资源功能可用 |
| M5: 支付系统完成 | 第13周末 | VIP购买功能上线 |
| M6: 管理后台完成 | 第15周末 | 完整的管理后台可用 |
| M7: 系统上线 | 第17周末 | 正式上线运营 |

### 8.5 风险评估与应对

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|---------|
| 爬虫被封禁 | 高 | 高 | 准备多个备用数据源,使用代理池 |
| 大模型API限流 | 中 | 中 | 部署本地模型作为备份 |
| 数据库性能瓶颈 | 中 | 高 | 提前做好分库分表规划 |
| 存储空间不足 | 中 | 高 | 使用对象存储,配置自动扩容 |
| 支付接口对接延迟 | 低 | 中 | 提前申请商户账号 |
| 人员变动 | 低 | 高 | 做好文档和代码注释 |

### 8.6 资源需求

#### 8.6.1 人力资源

| 角色 | 人数 | 工作周期 | 备注 |
|------|------|---------|------|
| 后端开发工程师 | 2人 | 17周 | 全程参与 |
| 前端开发工程师 | 1人 | 3周 | 完善前端功能 |
| 算法工程师 | 1人 | 2周 | 推荐系统开发 |
| 测试工程师 | 1人 | 2周 | 测试阶段 |
| 运维工程师 | 1人 | 3周 | 部署和监控 |
| 产品经理 | 1人 | 全程 | 需求管理 |
| UI设计师 | 1人 | 按需 | 界面优化 |

#### 8.6.2 硬件资源

**开发环境**:
- 开发服务器: 2台(8核16G)
- 测试服务器: 2台(8核16G)
- 数据库服务器: 1台(16核32G)
- Redis服务器: 1台(8核16G)

**生产环境**:
- Web服务器: 3台(16核32G) - 负载均衡
- 数据库服务器: 2台(32核64G) - 主从复制
- Redis集群: 3台(16核32G)
- Elasticsearch集群: 3台(16核32G)
- 文件存储: 10TB起步
- CDN: 按流量计费

#### 8.6.3 软件资源

| 软件/服务 | 用途 | 费用估算 |
|-----------|------|---------|
| 云服务器 | 应用部署 | ¥5000/月 |
| 对象存储 | 文件存储 | ¥1000/月 |
| CDN | 内容分发 | ¥2000/月 |
| 域名 | 网站访问 | ¥100/年 |
| SSL证书 | HTTPS | ¥500/年 |
| OpenAI API | 大模型服务 | ¥1000/月 |
| 代理服务 | 爬虫代理 | ¥500/月 |
| 支付通道 | 支付服务 | 按交易额收费 |
| **月度总计** | - | **约¥10000/月** |

---

## 9. 部署与运维

### 9.1 部署架构

```
                    ┌─────────────┐
                    │   用户端    │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │   CDN       │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │   Nginx     │
                    │  负载均衡    │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐       ┌────▼────┐       ┌────▼────┐
   │ Web服务1 │       │ Web服务2 │       │ Web服务3 │
   │ (前端)   │       │ (前端)   │       │ (前端)   │
   └────┬────┘       └────┬────┘       └────┬────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
                    ┌──────▼──────┐
                    │   API网关   │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐       ┌────▼────┐       ┌────▼────┐
   │ 后端服务1│       │ 后端服务2│       │ 后端服务3│
   └────┬────┘       └────┬────┘       └────┬────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐       ┌────▼────┐       ┌────▼────┐
   │  MySQL  │       │  Redis  │       │   ES    │
   │  主从   │       │  集群   │       │  集群   │
   └─────────┘       └─────────┘       └─────────┘
```

### 9.2 Nginx配置

```nginx
# 负载均衡配置
upstream backend {
    server 192.168.1.101:8080 weight=1;
    server 192.168.1.102:8080 weight=1;
    server 192.168.1.103:8080 weight=1;
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name example.com www.example.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS配置
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;
    
    # SSL证书
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 前端静态文件
    location / {
        root /var/www/html;
        try_files $uri $uri/ /index.html;
        
        # 缓存配置
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
    
    # API代理
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 文件上传大小限制
    client_max_body_size 100M;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;
}
```

### 9.3 Docker部署

#### 9.3.1 Dockerfile

**后端Dockerfile**:
```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

# 复制jar包
COPY target/movie-backend.jar app.jar

# 暴露端口
EXPOSE 8080

# 启动应用
ENTRYPOINT ["java", "-jar", "-Dspring.profiles.active=prod", "app.jar"]
```

**前端Dockerfile**:
```dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY package.json pnpm-lock.yaml ./

# 安装依赖
RUN npm install -g pnpm && pnpm install

# 复制源代码
COPY . .

# 构建
RUN pnpm build

# 生产镜像
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### 9.3.2 Docker Compose

```yaml
version: '3.8'

services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: movie-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: movie_db
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    networks:
      - movie-network
    restart: unless-stopped

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: movie-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - movie-network
    restart: unless-stopped

  # Elasticsearch
  elasticsearch:
    image: elasticsearch:8.11.0
    container_name: movie-es
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    volumes:
      - es-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - movie-network
    restart: unless-stopped

  # 后端服务
  backend:
    build:
      context: ./KneneBackend
      dockerfile: Dockerfile
    container_name: movie-backend
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/movie_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      ELASTICSEARCH_HOST: elasticsearch
    depends_on:
      - mysql
      - redis
      - elasticsearch
    ports:
      - "8080:8080"
    networks:
      - movie-network
    restart: unless-stopped

  # 前端服务
  frontend:
    build:
      context: ./MovieFront
      dockerfile: Dockerfile
    container_name: movie-frontend
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
    networks:
      - movie-network
    restart: unless-stopped

volumes:
  mysql-data:
  redis-data:
  es-data:

networks:
  movie-network:
    driver: bridge
```

### 9.4 监控配置

#### 9.4.1 Prometheus配置

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Spring Boot应用监控
  - job_name: 'spring-boot'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['backend:8080']
  
  # MySQL监控
  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-exporter:9104']
  
  # Redis监控
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
  
  # Nginx监控
  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx-exporter:9113']
```

#### 9.4.2 Grafana面板

创建以下监控面板:
1. **系统概览**: CPU、内存、磁盘、网络
2. **应用性能**: 请求量、响应时间、错误率
3. **数据库监控**: 连接数、慢查询、QPS
4. **缓存监控**: 命中率、内存使用、键数量
5. **业务指标**: 用户数、下载量、收入

### 9.5 备份策略

#### 9.5.1 数据库备份

```bash
#!/bin/bash
# 数据库备份脚本

BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/movie_db_$DATE.sql.gz"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -h localhost -u root -p$MYSQL_ROOT_PASSWORD movie_db | gzip > $BACKUP_FILE

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

# 上传到云存储(可选)
# aws s3 cp $BACKUP_FILE s3://backup-bucket/mysql/
```

#### 9.5.2 定时备份

```cron
# 每天凌晨3点备份数据库
0 3 * * * /scripts/backup-mysql.sh

# 每周日凌晨4点备份Redis
0 4 * * 0 /scripts/backup-redis.sh

# 每月1号备份完整系统
0 5 1 * * /scripts/backup-full.sh
```

### 9.6 运维手册

#### 9.6.1 常见问题处理

**问题1: 服务无响应**
```bash
# 检查服务状态
docker ps
systemctl status nginx

# 查看日志
docker logs movie-backend
tail -f /var/log/nginx/error.log

# 重启服务
docker restart movie-backend
systemctl restart nginx
```

**问题2: 数据库连接失败**
```bash
# 检查MySQL状态
docker exec -it movie-mysql mysql -u root -p

# 检查连接数
SHOW PROCESSLIST;

# 检查慢查询
SHOW VARIABLES LIKE 'slow_query_log';
```

**问题3: Redis内存不足**
```bash
# 查看内存使用
docker exec -it movie-redis redis-cli INFO memory

# 清理过期键
docker exec -it movie-redis redis-cli --scan --pattern "expired:*" | xargs redis-cli DEL

# 调整内存策略
docker exec -it movie-redis redis-cli CONFIG SET maxmemory-policy allkeys-lru
```

#### 9.6.2 性能优化

1. **数据库优化**
   - 添加索引
   - 优化慢查询
   - 配置连接池
   - 读写分离

2. **缓存优化**
   - 热点数据预热
   - 缓存穿透防护
   - 缓存雪崩防护
   - 合理设置过期时间

3. **应用优化**
   - 代码优化
   - 异步处理
   - 批量操作
   - 连接池配置

4. **前端优化**
   - 代码分割
   - 图片懒加载
   - CDN加速
   - Gzip压缩

---

## 10. 总结

### 10.1 项目特点

1. **技术先进**: 采用最新的技术栈和架构设计
2. **功能完整**: 涵盖用户、内容、下载、支付等完整功能
3. **智能化**: 集成大模型实现智能推荐和内容理解
4. **可扩展**: DDD架构设计,易于扩展和维护
5. **高性能**: 缓存、CDN、负载均衡等优化措施

### 10.2 后续规划

1. **短期目标(1-3个月)**
   - 完成核心功能开发
   - 上线MVP版本
   - 积累初始用户

2. **中期目标(3-6个月)**
   - 完善所有功能
   - 优化用户体验
   - 扩大用户规模

3. **长期目标(6-12个月)**
   - 移动端APP开发
   - 国际化支持
   - 社区功能完善
   - 商业化运营

### 10.3 成功关键因素

1. **团队协作**: 前后端紧密配合,高效沟通
2. **质量保证**: 完善的测试和代码审查
3. **用户体验**: 简洁易用的界面设计
4. **内容质量**: 高质量的资源和准确的信息
5. **技术创新**: 大模型等新技术的应用
6. **运营推广**: 有效的市场推广策略

---

**文档结束**

> 本文档将持续更新,请关注最新版本。  
> 如有疑问或建议,请联系项目负责人。

